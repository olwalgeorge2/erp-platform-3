name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

concurrency:
  # Allow parallel runs for different branches/PRs, cancel only for same ref
  group: ${{ github.workflow }}-${{ github.ref }}
  # Only cancel in-progress for PR pushes, not for main branch
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' }}

jobs:
  matrix-build:
    name: Matrix Build (JDK 21)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build (Linux)
        if: runner.os != 'Windows'
        run: ./gradlew build -PwithContainers=false -DwithContainers=false --no-daemon
      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: .\gradlew.bat build -PwithContainers=false -DwithContainers=false --no-daemon

  # Phase 1: Dependency & Cache Warmup
  dependency-cache-warmup:
    name: Dependency Cache Warmup
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Warm up Gradle cache
        run: ./gradlew dependencies --no-daemon

  # Phase 2: Parallel Quality Checks
  code-style-check:
    name: Code Style Check
    runs-on: ubuntu-latest
    needs: dependency-cache-warmup
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run ktlint
        run: ./gradlew ktlintCheck --no-daemon

  # Phase 3: Build & Unit Tests (no containers)
  build-and-unit-tests:
    name: Build & Unit Tests (No Containers)
    runs-on: ubuntu-latest
    needs: [dependency-cache-warmup, code-style-check]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build and run unit tests (without containers)
        run: ./gradlew build test -PwithContainers=false -DwithContainers=false --no-daemon
      
      - name: Upload test reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-unit
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

  # Phase 3.5: Container Integration Tests (Docker-dependent tests only)
  containers-it:
    name: Integration Tests (Testcontainers)
    runs-on: ubuntu-latest
    needs: [dependency-cache-warmup]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Run container-dependent integration tests
        env:
          TESTCONTAINERS_RYUK_DISABLED: "true"
        run: |
          # Only run tests that require Docker (api-gateway Redis/circuit breaker, identity Kafka)
          ./gradlew \
            :api-gateway:test \
            :bounded-contexts:tenancy-identity:identity-infrastructure:test \
            -PwithContainers=true \
            -DwithContainers=true \
            --no-daemon \
            --info
      
      - name: Upload container test reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-containers
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7

  # Phase 4: Parallel Architecture & Security Analysis
  architecture-governance:
    name: Architecture Governance
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run ArchUnit tests
        run: ./gradlew :tests:arch:test --no-daemon

  security-scan:
    name: Security Scan (OWASP)
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run OWASP dependency check
        run: |
          # Run dependency check with pre-configured settings
          # Skip for now due to NVD API issues - TODO: re-enable when stable
          echo "OWASP dependency check temporarily disabled due to NVD API stability issues"
      
      - name: Upload OWASP report on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: |
            **/build/reports/dependency-check-report.html
            **/build/reports/dependency-check-report.json
          retention-days: 14
      
      - name: Upload OWASP report for review (success)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report-clean
          path: |
            **/build/reports/dependency-check-report.html
          retention-days: 7

  # Phase 6: Publish Monitoring Assets (Grafana + Prometheus)
  publish-monitoring-assets:
    name: Publish Monitoring Assets
    runs-on: ubuntu-latest
    needs: [containers-it]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Upload Grafana Dashboard (API Gateway)"
        uses: actions/upload-artifact@v4
        with:
          name: grafana-api-gateway-dashboard
          path: dashboards/grafana/api-gateway-dashboard.json
          if-no-files-found: warn
          retention-days: 14

      - name: "Upload Prometheus Alerts (API Gateway)"
        uses: actions/upload-artifact@v4
        with:
          name: prometheus-api-gateway-alerts
          path: monitoring/prometheus/api-gateway-alerts.yml
          if-no-files-found: warn
          retention-days: 14

  # Phase 6.5: Smoke (liveness only)
  smoke:
    name: Smoke (Liveness Only)
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run smoke
        run: bash .github/scripts/smoke.sh

  proxy-smoke:
    name: Proxy Smoke
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run proxy smoke
        run: bash .github/scripts/proxy-smoke.sh

  k6-smoke:
    name: k6 Smoke (Perf)
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Setup k6
        uses: grafana/setup-k6-action@v1
      - name: Run k6 smoke
        run: bash .github/scripts/k6-smoke.sh
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Summarize k6 metrics
        run: |
          if [ -f /tmp/k6-summary.json ]; then
            AVG=$(jq -r '.metrics.http_req_duration.avg' /tmp/k6-summary.json)
            P95=$(jq -r '.metrics.http_req_duration["p(95)"]' /tmp/k6-summary.json)
            RPS=$(jq -r '.metrics.http_reqs.rate' /tmp/k6-summary.json)
            {
              echo "### k6 Smoke Summary"
              echo "- Avg latency (ms): $AVG"
              echo "- P95 latency (ms): $P95"
              echo "- RPS: $RPS"
            } >> $GITHUB_STEP_SUMMARY
          fi
      - name: Comment k6 summary on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('/tmp/k6-summary.json')) { return }
            const s = JSON.parse(fs.readFileSync('/tmp/k6-summary.json','utf8'));
            const avg = s.metrics.http_req_duration.avg;
            const p95 = s.metrics.http_req_duration['p(95)'];
            const rps = s.metrics.http_reqs.rate;
            const body = `### k6 Smoke Summary\n- Avg latency (ms): ${avg}\n- P95 latency (ms): ${p95}\n- RPS: ${rps}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

  # Phase 7: Final Status Check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    # Only depend on jobs that always run (exclude conditional jobs like docker-publish)
    needs: [
      matrix-build, 
      code-style-check, 
      build-and-unit-tests, 
      containers-it, 
      architecture-governance, 
      security-scan, 
      publish-monitoring-assets, 
      smoke, 
      proxy-smoke,
      k6-smoke
    ]
    if: always()
    steps:
      - name: "Check CI status"
        shell: bash
        run: |
          # Check all required jobs (not conditional ones)
          FAILED=0
          
          if [[ "${{ needs.matrix-build.result }}" == "failure" ]]; then
            echo "❌ Matrix Build failed"; FAILED=1
          fi
          if [[ "${{ needs.code-style-check.result }}" == "failure" ]]; then
            echo "❌ Code Style Check failed"; FAILED=1
          fi
          if [[ "${{ needs.build-and-unit-tests.result }}" == "failure" ]]; then
            echo "❌ Build & Unit Tests failed"; FAILED=1
          fi
          if [[ "${{ needs.containers-it.result }}" == "failure" ]]; then
            echo "❌ Container Integration Tests failed"; FAILED=1
          fi
          if [[ "${{ needs.architecture-governance.result }}" == "failure" ]]; then
            echo "❌ Architecture Governance failed"; FAILED=1
          fi
          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "❌ Security Scan failed"; FAILED=1
          fi
          if [[ "${{ needs.smoke.result }}" == "failure" ]]; then
            echo "❌ Smoke Test failed"; FAILED=1
          fi
          if [[ "${{ needs.proxy-smoke.result }}" == "failure" ]]; then
            echo "❌ Proxy Smoke Test failed"; FAILED=1
          fi
          if [[ "${{ needs.k6-smoke.result }}" == "failure" ]]; then
            echo "❌ k6 Smoke Test failed"; FAILED=1
          fi
          
          if [[ $FAILED -eq 1 ]]; then
            echo ""; echo "CI Pipeline Failed ❌"
            exit 1
          else
            echo "✅ All required CI checks passed"
          fi

  docker-publish:
    name: Docker Build & Publish (GHCR)
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build image
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/api-gateway
          docker build -t $IMAGE:${{ github.sha }} -f api-gateway/Dockerfile .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
      - name: Push image (sha tag)
        run: |
          docker push $IMAGE:${{ github.sha }}
      - name: Tag latest on default branch
        if: github.ref_name == 'main' || github.ref_name == 'master'
        run: |
          docker tag $IMAGE:${{ github.sha }} $IMAGE:latest
          docker push $IMAGE:latest

  sbom:
    name: SBOM (CycloneDX)
    runs-on: ubuntu-latest
    needs: docker-publish
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate SBOM from image
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository_owner }}/api-gateway:${{ github.sha }}
          format: cyclonedx-json
          output-file: sbom-api-gateway.cdx.json
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-api-gateway
          path: sbom-api-gateway.cdx.json

  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: docker-publish
    steps:
      - name: Scan image (fail on CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/api-gateway:${{ github.sha }}
          format: 'table'
          ignore-unfixed: true
          severity: 'CRITICAL'
          exit-code: '1'

  # Optional: Helm chart packaging (for deployment artifacts, not required for CI to pass)
  helm-package:
    name: Helm Package (Optional)
    runs-on: ubuntu-latest
    needs: [docker-publish]
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4
      - name: Lint chart
        run: helm lint charts/api-gateway
      - name: Package chart
        run: helm package charts/api-gateway --destination dist
      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-api-gateway
          path: dist/*.tgz
          retention-days: 30
