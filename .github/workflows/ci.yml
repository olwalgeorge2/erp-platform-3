name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ "**" ]

jobs:
  # ═══════════════════════════════════════════════════════════════
  # Phase 1: Dependency & Cache Warmup
  # ═══════════════════════════════════════════════════════════════
  dependency-cache-warmup:
    name: Dependency Cache Warmup
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Warm up Gradle cache
        run: ./gradlew dependencies --no-daemon

  # ═══════════════════════════════════════════════════════════════
  # Phase 2: Parallel Quality Checks
  # ═══════════════════════════════════════════════════════════════
  code-style-check:
    name: Code Style Check
    runs-on: ubuntu-latest
    needs: dependency-cache-warmup
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run ktlint
        run: ./gradlew ktlintCheck --no-daemon

  # ═══════════════════════════════════════════════════════════════
  # Phase 3: Build & Unit Tests
  # ═══════════════════════════════════════════════════════════════
  build-and-unit-tests:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    needs: [dependency-cache-warmup, code-style-check]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build and run unit tests
        run: ./gradlew build test -PwithContainers=false --no-daemon

  # ═══════════════════════════════════════════════════════════════
  # Phase 4: Parallel Architecture & Security Analysis
  # ═══════════════════════════════════════════════════════════════
  architecture-governance:
    name: Architecture Governance
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run ArchUnit tests
        run: ./gradlew :tests:arch:test --no-daemon

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-unit-tests
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run OWASP dependency check
        run: ./gradlew dependencyCheckAnalyze --no-daemon || true

  # ═══════════════════════════════════════════════════════════════
  # Phase 5: Integration Tests
  # ═══════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-and-unit-tests, architecture-governance]
    permissions:
      contents: read
    env:
      ORG_GRADLE_PROJECT_withContainers: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Run integration tests with Testcontainers
        run: ./gradlew test --no-daemon

  # ═══════════════════════════════════════════════════════════════
  # Phase 6: Final Status Check
  # ═══════════════════════════════════════════════════════════════
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [code-style-check, build-and-unit-tests, architecture-governance, security-scan, integration-tests]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.code-style-check.result }}" == "failure" || \
                "${{ needs.build-and-unit-tests.result }}" == "failure" || \
                "${{ needs.architecture-governance.result }}" == "failure" || \
                "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
          fi

