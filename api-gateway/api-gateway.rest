### API Gateway - Health Check Tests
### Use with REST Client extension in VS Code

@baseUrl = http://localhost:8080
@identityUrl = http://localhost:8081

###############################################################################
# Health Check Endpoints - ✅ UPDATED FOR CURRENT SERVICES
###############################################################################

### 1. Full Health Check (All checks)
GET {{baseUrl}}/q/health
Accept: application/json

### 2. Liveness Check (JVM Health - Memory & Threads)
GET {{baseUrl}}/q/health/live
Accept: application/json

### 3. Readiness Check (Redis + Backend Services)
GET {{baseUrl}}/q/health/ready
Accept: application/json

### 4. Startup Check
GET {{baseUrl}}/q/health/started
Accept: application/json

###############################################################################
# Quarkus Dev UI - ✅ ADDED FOR DEVELOPMENT
###############################################################################

### 5. API Gateway Quarkus Dev UI
GET {{baseUrl}}/q/dev-ui/
Accept: text/html

### 6. API Gateway Swagger UI
GET {{baseUrl}}/q/swagger-ui/
Accept: text/html

###############################################################################
# Direct Identity Service Health (Bypassing Gateway)
###############################################################################

### 7. Identity Service - Full Health
GET {{identityUrl}}/q/health
Accept: application/json

### 8. Identity Service - Liveness
GET {{identityUrl}}/q/health/live
Accept: application/json

### 9. Identity Service - Readiness
GET {{identityUrl}}/q/health/ready
Accept: application/json

### 10. Identity Service Quarkus Dev UI
GET {{identityUrl}}/q/dev-ui/
Accept: text/html

###############################################################################
# API Gateway - Metrics & Monitoring
###############################################################################

### 8. Prometheus Metrics
GET {{baseUrl}}/q/metrics
Accept: text/plain

### 9. OpenAPI Spec
GET {{baseUrl}}/q/openapi
Accept: application/json

###############################################################################
# API Gateway - Routing Tests (Identity via versioned aliases)
###############################################################################

### 13a. Identity Health (alias) -> /q/health
GET {{baseUrl}}/api/v1/identity/health
Accept: application/json

### 13b. Identity Readiness (alias) -> /q/health/ready
GET {{baseUrl}}/api/v1/identity/health/ready
Accept: application/json

### 13c. Identity Liveness (alias) -> /q/health/live
GET {{baseUrl}}/api/v1/identity/health/live
Accept: application/json

### 13d. Identity Health (raw platform path) -> /q/health/ready
GET {{baseUrl}}/api/v1/identity/q/health/ready
Accept: application/json

###############################################################################
# API Tests - ✅ UPDATED WITH ACTUAL ENDPOINTS
###############################################################################

### 11. Test Identity Service API - List Tenants (Direct)
GET {{identityUrl}}/api/tenants
Accept: application/json

### 12. Test Identity Service API - Role Templates (Direct)
GET {{identityUrl}}/api/roles/templates
Accept: application/json

### 13. Test through API Gateway - List Tenants (if proxied)
GET {{baseUrl}}/api/v1/identity/tenants
Accept: application/json

### 14. Create a Test Tenant (Direct to Identity Service)
POST {{identityUrl}}/api/tenants
Content-Type: application/json

{
  "name": "Test Tenant {{$randomInt 1000 9999}}",
  "slug": "test-{{$randomInt 100000 999999}}",
  "subscription": {
    "plan": "STARTER",
    "startDate": "{{$datetime rfc3339}}",
    "maxUsers": 10,
    "maxStorage": 1000,
    "features": ["rbac"]
  }
}

> {%
  if (response.status === 201 && response.body && response.body.id) {
    client.global.set("testTenantId", response.body.id);
  }
%}

###############################################################################
# Redis Health Simulation Tests
###############################################################################

### 14. Test with Redis Running (Should be UP)
# Prerequisites: docker compose -f docker-compose-kafka.yml up -d redis
GET {{baseUrl}}/q/health/ready
Accept: application/json

### 15. Simulate Redis Failure
# To test: docker stop erp-redis
# Then run the readiness check - should show Redis DOWN
# GET {{baseUrl}}/q/health/ready

###############################################################################
# Backend Service Health Simulation Tests
###############################################################################

### 16. Test with Identity Service Running (Should be UP)
GET {{baseUrl}}/q/health/ready
Accept: application/json

### 17. Simulate Identity Service Failure
# To test: Stop identity service (port 8081)
# Then run the readiness check - should show Backend Service DOWN
# GET {{baseUrl}}/q/health/ready

###############################################################################
# Memory/Thread Stress Tests (Liveness)
###############################################################################

### 18. Check Memory Usage
# Liveness should be UP if heap usage < 95%
GET {{baseUrl}}/q/health/live
Accept: application/json

### 19. Check for Thread Deadlocks
# Liveness should be UP if no deadlocks detected
GET {{baseUrl}}/q/health/live
Accept: application/json

###############################################################################
# Kubernetes Integration Tests
###############################################################################

### 20. Liveness Probe (K8s would call this)
# If this returns DOWN, K8s will restart the pod
GET {{baseUrl}}/q/health/live
Accept: application/json

### 21. Readiness Probe (K8s would call this)
# If this returns DOWN, K8s will remove pod from load balancer
GET {{baseUrl}}/q/health/ready
Accept: application/json

### 22. Startup Probe (K8s would call this during startup)
# If this returns DOWN, K8s will wait before checking liveness/readiness
GET {{baseUrl}}/q/health/started
Accept: application/json

###############################################################################
# Expected Responses
###############################################################################

# Healthy Response (200 OK):
# {
#   "status": "UP",
#   "checks": [
#     {
#       "name": "Redis readiness",
#       "status": "UP",
#       "data": {
#         "latency_ms": 2
#       }
#     },
#     {
#       "name": "Backend services health",
#       "status": "UP",
#       "data": {
#         "identity-service": "UP"
#       }
#     }
#   ]
# }

# Unhealthy Response (503 Service Unavailable):
# {
#   "status": "DOWN",
#   "checks": [
#     {
#       "name": "Redis readiness",
#       "status": "DOWN",
#       "data": {
#         "error": "Connection refused"
#       }
#     }
#   ]
# }

###############################################################################
# Test Scenarios
###############################################################################

# Scenario 1: All services healthy
# - Start all Docker services: docker compose -f docker-compose-kafka.yml up -d
# - Start Identity service: .\scripts\dev-identity.ps1
# - Start API Gateway: .\scripts\dev-gateway.ps1
# - Run: GET {{baseUrl}}/q/health/ready
# - Expected: status=UP, all checks UP

# Scenario 2: Redis down
# - docker stop erp-redis
# - Run: GET {{baseUrl}}/q/health/ready
# - Expected: status=DOWN, Redis check DOWN, Gateway removed from K8s LB

# Scenario 3: Identity service down
# - Stop identity service
# - Run: GET {{baseUrl}}/q/health/ready
# - Expected: status=DOWN, Backend service check DOWN

# Scenario 4: High memory usage
# - Load test or memory leak simulation
# - Run: GET {{baseUrl}}/q/health/live
# - Expected: status=DOWN if heap > 95%, K8s would restart pod

###############################################################################
