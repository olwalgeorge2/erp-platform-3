quarkus:
  http:
    port: ${API_GATEWAY_PORT:8080}
    host: ${API_GATEWAY_HOST:0.0.0.0}
    cors:
      origins: ${CORS_ORIGINS:http://localhost:3000}
      methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
      headers: Authorization,Content-Type,X-Trace-Id,X-Tenant-Id,X-User-Id
      exposed-headers: Location,X-Total-Count,X-RateLimit-Limit,X-RateLimit-Remaining
      access-control-max-age: 3600

  redis:
    hosts: ${REDIS_URL:redis://localhost:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 10s

  log:
    console:
      json: ${QUARKUS_LOG_CONSOLE_JSON:true}
    level: ${QUARKUS_LOG_LEVEL:INFO}

  smallrye-openapi:
    path: /q/openapi
  swagger-ui:
    path: /q/swagger-ui
    always-include: true

mp:
  jwt:
    verify:
      publickey:
        location: ${JWT_PUBLIC_KEY_URL:http://localhost:8081/api/v1/identity/.well-known/jwks.json}
      issuer: ${JWT_ISSUER:erp-platform}
      # Accept only these audiences (comma-separated). Leave empty to skip audience check.
      audiences: ${JWT_AUDIENCES:}
  openapi:
    filter: com.erp.apigateway.openapi.DefaultResponsesFilter

smallrye:
  jwt:
    time:
      # Allowed clock skew in seconds when validating iat/exp/nbf
      allowed-clock-skew: ${JWT_ALLOWED_CLOCK_SKEW:30}

gateway:
  routes:
    # Identity platform endpoints (health, openapi, swagger)
    - pattern: "/api/v1/identity/q/*"
      base-url: ${IDENTITY_SERVICE_URL:http://localhost:8081}
      timeout: 5s
      retries: 0
      auth-required: false
      health-path: "/q/health/ready"
      backoff-initial-ms: 100
      backoff-max-ms: 1000
      backoff-jitter-ms: 50
      rewrite:
        remove-prefix: "/api/v1/identity"
        add-prefix: "/"

    # Identity health aliases under versioned API (clean external contract)
    - pattern: "/api/v1/identity/health"
      base-url: ${IDENTITY_SERVICE_URL:http://localhost:8081}
      timeout: 5s
      retries: 0
      auth-required: false
      health-path: "/q/health/ready"
      backoff-initial-ms: 100
      backoff-max-ms: 1000
      backoff-jitter-ms: 50
      rewrite:
        remove-prefix: "/api/v1/identity/health"
        add-prefix: "/q/health"

    - pattern: "/api/v1/identity/health/*"
      base-url: ${IDENTITY_SERVICE_URL:http://localhost:8081}
      timeout: 5s
      retries: 0
      auth-required: false
      health-path: "/q/health/ready"
      backoff-initial-ms: 100
      backoff-max-ms: 1000
      backoff-jitter-ms: 50
      rewrite:
        remove-prefix: "/api/v1/identity/health"
        add-prefix: "/q/health"
    # Identity business API endpoints under /api/*
    - pattern: "/api/v1/identity/api/*"
      base-url: ${IDENTITY_SERVICE_URL:http://localhost:8081}
      timeout: 5s
      retries: 2
      auth-required: false
      health-path: "/q/health/ready"
      backoff-initial-ms: 100
      backoff-max-ms: 1000
      backoff-jitter-ms: 50
      rewrite:
        remove-prefix: "/api/v1/identity"
        add-prefix: "/"
    # Financial accounting APIs
    - pattern: "/api/v1/finance/*"
      base-url: ${FINANCE_SERVICE_URL:http://localhost:8280}
      timeout: 10s
      retries: 2
      auth-required: true
      health-path: "/q/health/ready"
      backoff-initial-ms: 100
      backoff-max-ms: 1000
      backoff-jitter-ms: 50
      rewrite:
        remove-prefix: "/api/v1/finance"
        add-prefix: "/"

  public-prefixes:
    - "/api/v1/health"
    - "/api/v1/metrics"
    - "/q/health"
    - "/api/v1/identity/q"
    - "/api/v1/identity/health"
    # Dev convenience: open auth endpoints on identity business API
    - "/api/v1/identity/api/auth"

  rate-limits:
    default:
      requests-per-minute: ${RATE_LIMIT_DEFAULT_REQUESTS:100}
      window: ${RATE_LIMIT_DEFAULT_WINDOW:60s}

  auth:
    protected-prefixes:
      - "/api/v1/identity"
      - "/api/v1/tenancy"
      - "/api/v1/finance"
    scope-rules:
      - prefix: "/api/v1/finance"
        any-role:
          - financial-admin
          - financial-user
          - financial-auditor

# Flat property for @ConfigProperty injection (not nested)
gateway.timing-guard.min-failure-duration-ms: 100

"%dev":
  quarkus:
    kafka:
      devservices:
        enabled: false
  gateway:
    auth:
      protected-prefixes: []
      scope-rules: []
