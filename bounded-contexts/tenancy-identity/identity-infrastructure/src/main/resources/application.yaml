quarkus:
  http:
    port: ${QUARKUS_HTTP_PORT:8081}
  datasource:
    db-kind: postgresql
    username: ${QUARKUS_DATASOURCE_USERNAME:erp_user}
    password: ${QUARKUS_DATASOURCE_PASSWORD:erp_pass}
    jdbc:
      url: ${QUARKUS_DATASOURCE_JDBC_URL:jdbc:postgresql://localhost:5432/erp_identity}
      driver: org.postgresql.Driver
    devservices:
      enabled: false
  hibernate-orm:
    validate-in-dev-mode: true
  flyway:
    migrate-at-start: true
    locations: classpath:db/migration
    baseline-on-migrate: true
  log:
    console:
      format: "%d{HH:mm:ss} %-5p [%c{3.}] (%t) %s%e%n"
    level: INFO

"%dev":
  quarkus:
    http:
      port: ${QUARKUS_HTTP_PORT:8181}
    analytics:
      disabled: true
    datasource:
      username: ${QUARKUS_DATASOURCE_USERNAME:erp_user}
      password: ${QUARKUS_DATASOURCE_PASSWORD:erp_pass}
      jdbc:
        url: ${QUARKUS_DATASOURCE_JDBC_URL:jdbc:postgresql://localhost:5432/erp_identity}
  app:
    environment: DEVELOPMENT

"%prod":
  quarkus:
    datasource:
      devservices:
        enabled: false
    hibernate-orm:
      database:
        generation: validate

"%test":
  quarkus:
    http:
      # Use an ephemeral port during @QuarkusTest to avoid clashes with a running dev server
      test-port: 0
    log:
      level: WARN

mp:
  messaging:
    outgoing:
      identity-events-out:
        connector: smallrye-kafka
        topic: ${IDENTITY_EVENTS_TOPIC:identity.domain.events.v1}
        bootstrap:
          servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
        key:
          serializer: org.apache.kafka.common.serialization.StringSerializer
        value:
          serializer: org.apache.kafka.common.serialization.StringSerializer
        acks: all  # Wait for all in-sync replicas
        retries: 3
        enable:
          idempotence: true  # Exactly-once semantics
        max:
          in:
            flight:
              requests:
                per:
                  connection: 5
        # Dead Letter Queue configuration for failed events
        failure-strategy: dead-letter-queue
        dead-letter-queue:
          topic: ${IDENTITY_EVENTS_DLQ_TOPIC:identity.domain.events.dlq}
          key:
            serializer: org.apache.kafka.common.serialization.StringSerializer
          value:
          serializer: org.apache.kafka.common.serialization.StringSerializer

    incoming:
      identity-events-in:
        connector: smallrye-kafka
        topic: ${IDENTITY_EVENTS_TOPIC:identity.domain.events.v1}
        bootstrap:
          servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
        group:
          id: ${IDENTITY_EVENTS_GROUP_ID:identity-infra-consumer}
        auto:
          offset:
            reset: earliest
        # Route failures to DLQ
        failure-strategy: dead-letter-queue
        dead-letter-queue:
          topic: ${IDENTITY_EVENTS_DLQ_TOPIC:identity.domain.events.dlq}
          key:
            serializer: org.apache.kafka.common.serialization.StringSerializer
          value:
            serializer: org.apache.kafka.common.serialization.StringSerializer

app:
  environment: PRODUCTION



