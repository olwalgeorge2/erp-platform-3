# Observability Baseline (API Gateway & Tenancy-Identity)

_Last updated: 2025‑11‑13_

This runbook captures the required signals (logs, metrics, traces) for the two cross‑cutting services that Front Door traffic depends on. Every downstream bounded context should adopt the same propagation contract so we get tenant/user context and request lineage end‑to‑end.

---

## 1. Signal Matrix

| Layer | Logs | Metrics | Traces / Correlation |
|-------|------|---------|----------------------|
| API Gateway (`api-gateway/…`) | JSON console logs + request/response audit via `RequestLoggingFilter` (`X-Trace-Id`, headers masked) | Micrometer counters & timers in `GatewayMetrics` (`gateway_requests_total`, `gateway_request_duration_seconds`, `gateway_errors_total`, Redis/bulkhead gauges, etc.) | `X-Trace-Id` header is mandatory; gateway also generates/echoes W3C `traceparent` if missing. |
| Tenancy-Identity (`bounded-contexts/tenancy-identity/identity-infrastructure/…`) | `RequestLoggingFilter` captures `X-Trace-ID`, `X-Tenant-ID`, roles/permissions and pushes them into MDC; `IdentityCommandService` logs start/stop w/ trace + tenant context | Micrometer annotations on command handlers (`identity.user.creation.*`, etc.), outbox gauges/counters (`identity.outbox.events.*`) and Quarkus default `/q/metrics` exporters | Same `X-Trace-ID` header contract; MDC trace id is forwarded to JMS/Kafka outbox (`KafkaOutboxMessagePublisher`) to keep event lineage. |

**Propagation contract**

- `X-Trace-Id` → optional on ingress, generated by gateway if absent, echoed to callers by both services.
- `traceparent` / `tracestate` → supported for W3C clients; gateway will create a span id if missing.
- `X-Tenant-Id`, `X-User-Id`, `X-User-Roles`, `X-User-Permissions` → required for authenticated calls leaving the gateway so downstream services can log + authorize consistently.

---

## 2. API Gateway Observability

### 2.1 Logging
- **Location:** `api-gateway/src/main/kotlin/com.erp.apigateway/logging/RequestLoggingFilter.kt`
- **Behavior:** On every request, the filter pulls `X-Trace-Id` from headers (or leaves empty), masks sensitive headers (Authorization), and emits a JSON log line (`QUARKUS_LOG_CONSOLE_JSON` defaulted to `true` in `application.yml`). Response filter logs status + headers and clears MDC.
- **What to look for:** `traceId`, HTTP method/path, sanitized headers. These map to the same correlation id the client receives in the response.

### 2.2 Metrics
- **Implementation:** `GatewayMetrics` registers Micrometer counters/timers. Key series exposed under `/q/metrics`:
  - `gateway_requests_total{method,endpoint,status}`
  - `gateway_request_duration_seconds{…}`
  - `gateway_errors_total{type}`
  - `gateway_ratelimit_exceeded_total{tenant}`
  - `gateway_auth_failures_total{reason}`
  - Gauges: `gateway_backend_up{service}`, `gateway_redis_up`, `gateway_redis_latency_ms`, `gateway_circuit_state{route}`
- **Alerting seeds:** 5xx per minute, auth failures by reason, backend down gauge flipping to 0.

### 2.3 Tracing
- Gateway accepts both `X-Trace-Id` and W3C `traceparent`.
- `TraceContext` (request-scoped bean) stores the active trace id for downstream components (exception mapper, metrics).
- Add `X-Trace-Id` to every outbound call (done inside `ProxyController`) so identity service sees the same id.

### 2.4 Health/Debug
- `/q/health/ready` → includes Redis connectivity + backend status check (calls each route’s `health-path`).
- `/q/metrics` → Prometheus scrape.

---

## 3. Tenancy-Identity Observability

### 3.1 Logging & Context
- **Request filter:** `identity-infrastructure/src/main/kotlin/com.erp.identity.infrastructure/web/RequestLoggingFilter.kt`
  - Generates a UUID trace id when missing and echoes it via `X-Trace-ID` response header.
  - Stores tenant/user context in `TenantRequestContext` + `RequestPrincipalContext` for later authorization checks.
  - Emits duration log lines (`HTTP <method> <path> -> <status> (<ms>)`) via Quarkus logger.
- **Command/service logs:** `IdentityCommandService` wraps every command with `@Counted/@Timed` and logs success/failure including `tenantId`, `userId`, etc., with MDC data.
- **Kafka outbox:** `KafkaOutboxMessagePublisher` copies MDC `traceId`/`tenantId` to Kafka headers for event consumers.

### 3.2 Metrics
- **Command handlers:** Micrometer annotations produce counters/timers such as:
  - `identity.user.creation.attempts`, `identity.user.creation.duration`
  - `identity.user.credential.update.duration`, `identity.role.management.*`, etc.
- **Outbox scheduler:** `identity.outbox.events.published{outcome=success|failure}`, `identity.outbox.batch.duration`, `identity.outbox.events.pending`.
- **Health endpoints:** Quarkus `/q/health` & `/q/metrics` expose DB/Flyway status, Kafka/Redpanda connectivity, Micrometer series.

### 3.3 Trace propagation
- `X-Trace-ID` required from gateway. Identity service will create one if invoked directly (local debugging) but still returns the header so clients can correlate.
- When emitting Kafka events, the outbox publisher adds headers:
  - `trace-id`
  - `tenant-id` (if available)
  - `event-type`
  - Use these headers in downstream consumers to stitch the story.

---

## 4. Financial Accounting Observability

### 4.1 Logging & Context
- REST adapter (`FinanceCommandResource`) and `FinanceCommandService` log incoming commands with `X-Trace-Id`, `X-Tenant-Id`, ledger/chart/journal identifiers, and command ids. Sensitive attributes remain structured for audit review as required by ADR-009.
- MDC carries the identifiers above; `FinanceOutboxPublisher` copies them into outbox rows and `KafkaFinanceEventPublisher` forwards them as Kafka headers so downstream consumers can stitch the full story.
- Outbox scheduler + cleanup scheduler log batch counts, failures, and retention operations to ensure operational transparency.

### 4.2 Metrics
- Micrometer timers/counters exist for all finance commands (p95 targets: 200 ms for `postJournalEntry`, 300 ms for ledger/account commands) and now surface at `/q/metrics`.
- Outbox metrics added in this iteration:
  - `finance.outbox.events.published_total`
  - `finance.outbox.events.failed_total`
  - `finance.outbox.events.pending`
  - `finance.outbox.events.batch.size`
  - `finance.outbox.events.drain` (timer)
- These series back the SLA table in `SECURITY_SLA.md` and satisfy ADR-007 guidance on outbox observability.

### 4.3 Trace Propagation
- Same propagation contract as gateway/identity (`X-Trace-Id`, `traceparent`, tenant/user headers).
- Kafka events include `trace-id`, `tenant-id`, `ledger-id`, and `journal-entry-id` headers, enabling auditors to correlate the journal lifecycle across services, as mandated by ADR-009.

### 4.4 Testcontainers & Health
- `FinanceOutboxIntegrationTest` spins up Postgres + Redpanda via Testcontainers (`FinancePostgresTestResource`, `FinanceKafkaTestResource`) to validate REST → handler → outbox → Kafka, ensuring metrics/logging/health endpoints behave under realistic conditions.
- Health endpoints expose DB/Flyway status, Kafka connectivity, outbox scheduler state, and the Micrometer series listed above.

---

## 5. Verification Recipes

### 4.1 Manual curl checks
```bash
# Gateway readiness & metrics
curl -H "X-Trace-Id: demo-123" http://localhost:8080/q/health/ready
curl http://localhost:8080/q/metrics | rg gateway_requests_total

# Identity readiness & metrics
curl -H "X-Trace-Id: demo-456" http://localhost:8081/q/health/ready
curl http://localhost:8081/q/metrics | rg identity.user.creation
```

### 4.2 Log correlation
1. Call `http://localhost:8080/api/v1/identity/api/auth/login` with `-H "X-Trace-Id: trace-demo-1"`.
2. Check `gateway-output.log` and `identity-dev.out.log`; both will contain `trace-demo-1`, allowing you to follow the request through the stack.

### 4.3 Prometheus/Grafana (future)
- Scrape targets:
  - Gateway: `http://gateway-host:8080/q/metrics`
  - Identity: `http://identity-host:8081/q/metrics`
- Suggested dashboards:
  - Request volume by status/tenant.
  - Rate-limit breaches per tenant.
  - Identity command durations (p95) and failure counts.
  - Outbox pending gauge + failure counter (alerts when high for >5m).

---

## 6. Action Items / TODO

1. **Tracing backend:** Wire OpenTelemetry exporter (OTLP) in both services once collector endpoint is provisioned. Until then rely on `X-Trace-Id`.
2. **Grafana dashboards:** Import baseline dashboard JSON covering the metrics described above.
3. **Alert rules:**
   - Gateway 5xx rate > 1% over 5 minutes.
   - `gateway_backend_up{service=identity}` equals 0 for >30s.
   - `identity.outbox.events.pending` above 500 for >10m.
4. **Docs linkage:** Reference this file from `README.md` and future architecture docs so every context inherits the same contract.

---

### Appendix – File References

- Gateway logging & tracing:
  - `api-gateway/src/main/kotlin/com.erp.apigateway/logging/RequestLoggingFilter.kt`
  - `api-gateway/src/main/kotlin/com.erp.apigateway/metrics/GatewayMetrics.kt`
  - `api-gateway/src/main/resources/application.yml`
- Identity logging & metrics:
  - `bounded-contexts/tenancy-identity/identity-infrastructure/src/main/kotlin/com.erp.identity.infrastructure/web/RequestLoggingFilter.kt`
  - `bounded-contexts/tenancy-identity/identity-infrastructure/src/main/kotlin/com.erp.identity.infrastructure/service/IdentityCommandService.kt`
  - `bounded-contexts/tenancy-identity/identity-infrastructure/src/main/kotlin/com.erp.identity.infrastructure/outbox/OutboxEventScheduler.kt`
- Financial accounting logging & metrics:
  - `bounded-contexts/financial-management/financial-accounting/accounting-infrastructure/src/main/kotlin/com/erp/finance/accounting/infrastructure/service/FinanceCommandService.kt`
  - `bounded-contexts/financial-management/financial-accounting/accounting-infrastructure/src/main/kotlin/com/erp/finance/accounting/infrastructure/outbox/FinanceOutboxEventScheduler.kt`
  - `bounded-contexts/financial-management/financial-accounting/accounting-infrastructure/src/main/kotlin/com/erp/finance/accounting/infrastructure/outbox/FinanceOutboxCleanupScheduler.kt`
  - `bounded-contexts/financial-management/financial-accounting/accounting-infrastructure/src/main/resources/application.yml`


