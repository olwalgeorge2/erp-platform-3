@host = http://localhost:8081

# These will be set during the flow
@tenantId = 00000000-0000-0000-0000-000000000000
@roleId = 00000000-0000-0000-0000-000000000000

# Simulated gateway-provided principal headers
@userId = rest-client-admin
@userRoles = SYSTEM_ADMIN
@userPermissions = roles:manage,roles:read

###############################################################################
# Health Check - âœ… VERIFY SERVICE IS RUNNING
###############################################################################

### Check Identity Service Health
GET {{host}}/q/health
Accept: application/json

### Check Identity Service Dev UI
GET {{host}}/q/dev-ui/
Accept: text/html

###############################################################################
# API Tests
###############################################################################

### Auth: expect 401 for unknown user (sanitized)
POST {{host}}/api/auth/login
Content-Type: application/json

{
  "tenantId": "{{$guid}}",
  "usernameOrEmail": "unknown.user@example.com",
  "password": "WrongPass123!"
}

### Provision tenant
POST {{host}}/api/tenants
Content-Type: application/json

{
  "name": "Smoke Tenant {{$randomInt 1000 9999}}",
  "slug": "smoke-{{$randomInt 100000 999999}}",
  "subscription": {
    "plan": "STARTER",
    "startDate": "{{$datetime rfc3339}}",
    "maxUsers": 10,
    "maxStorage": 1000,
    "features": ["rbac"]
  }
}

> {%
  if (response.status === 201 && response.body && response.body.id) {
    client.global.set("tenantId", response.body.id);
  }
%}

### Activate tenant
POST {{host}}/api/tenants/{{tenantId}}/activate
Content-Type: application/json

{}

### Create role
POST {{host}}/api/tenants/{{tenantId}}/roles
Content-Type: application/json
X-User-Id: {{userId}}
X-User-Roles: {{userRoles}}
X-User-Permissions: {{userPermissions}}
X-Tenant-ID: {{tenantId}}

{
  "name": "reader",
  "description": "Reader role",
  "permissions": [
    { "resource": "tenants", "action": "read", "scope": "TENANT" }
  ]
}

> {%
  if (response.status === 201 && response.body && response.body.id) {
    client.global.set("roleId", response.body.id);
  }
%}

### List roles
GET {{host}}/api/tenants/{{tenantId}}/roles?limit=10&offset=0
X-User-Id: {{userId}}
X-User-Roles: {{userRoles}}
X-User-Permissions: roles:read
X-Tenant-ID: {{tenantId}}

### Update role
PUT {{host}}/api/tenants/{{tenantId}}/roles/{{roleId}}
Content-Type: application/json
X-User-Id: {{userId}}
X-User-Roles: {{userRoles}}
X-User-Permissions: {{userPermissions}}
X-Tenant-ID: {{tenantId}}

{
  "name": "reader",
  "description": "Updated reader",
  "permissions": [
    { "resource": "tenants", "action": "read", "scope": "TENANT" },
    { "resource": "roles", "action": "read", "scope": "TENANT" }
  ]
}

### Delete role
DELETE {{host}}/api/tenants/{{tenantId}}/roles/{{roleId}}
X-User-Id: {{userId}}
X-User-Roles: {{userRoles}}
X-User-Permissions: {{userPermissions}}
X-Tenant-ID: {{tenantId}}

