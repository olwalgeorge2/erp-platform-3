#!/usr/bin/env bash
set -euo pipefail

echo "[pre-commit] Running code style and architecture governance checks"

# Allow bypass via environment variable
if [[ "${SKIP_ARCH_HOOK:-}" == "1" ]]; then
  echo "[pre-commit] SKIP_ARCH_HOOK=1 set. Skipping all pre-commit checks."
  exit 0
fi

if [[ ! -x "./gradlew" ]]; then
  echo "[pre-commit] gradlew not found or not executable. Aborting." >&2
  exit 1
fi

# Skip when only docs/markdown files are staged
changed_files=$(git diff --cached --name-only --diff-filter=ACMRTUXB)
if [[ -z "$changed_files" ]]; then
  echo "[pre-commit] No staged changes. Skipping."
  exit 0
fi

non_docs=$(echo "$changed_files" | grep -vE '^(docs/|README.md|CONTRIBUTING.md|.*\.md$)' || true)
# Further narrow to relevant code files/paths that can affect ArchUnit
code_changes=$(echo "$non_docs" | grep -E '^(bounded-contexts/|platform-shared/|platform-infrastructure/|api-gateway/|tests/arch/|buildSrc/|build.gradle.kts$|settings.gradle.kts$)|\.(kt|kts|java|gradle(\.kts)?)$' || true)

# Check for Kotlin files specifically for ktlint
kotlin_files=$(echo "$changed_files" | grep -E '\.(kt|kts)$' || true)

# Run ktlint if Kotlin files changed
if [[ -n "$kotlin_files" ]]; then
  echo "[pre-commit] Step 1/2: Running ktlint on Kotlin files..."
  echo "[pre-commit]   → Auto-formatting code..."
  ./gradlew ktlintFormat --no-daemon --stacktrace
  
  # Stage any files that were formatted
  git add -u
  
  echo "[pre-commit]   → Checking code style..."
  ./gradlew ktlintCheck --no-daemon --stacktrace
  echo "[pre-commit] ✓ ktlint passed"
else
  echo "[pre-commit] No Kotlin files changed, skipping ktlint"
fi

# Run architecture tests if relevant code changed
if [[ -z "$code_changes" ]]; then
  echo "[pre-commit] No relevant code changes for architecture tests. Skipping."
  exit 0
fi

echo "[pre-commit] Step 2/2: Running architecture tests..."
./gradlew :tests:arch:test --no-daemon --stacktrace

echo "[pre-commit] ✓ Architecture tests passed"
echo "[pre-commit] All checks passed! ✓"
